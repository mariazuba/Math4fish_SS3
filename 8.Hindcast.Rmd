---
title: "Hindcast Cross-Validation and prediction skill "
---

```{css,echo=FALSE}
.scroll-200{
            max-height: 200px; 
            overflow-y: auto; 
            background-color: #f1f1f1;
            }
```


```{css,echo=FALSE}
/*----------LOGO above TOC---------*/
#TOC::before {
  content: "";
  display: block;
  height: 100px;
  margin: 2em 20px 40px 20px;
  background-image: url("LOGO_2SN_recortado.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```



```{r global-options, include=FALSE}
knitr::opts_chunk$set(eval=T,echo=T, warning=FALSE, message=FALSE,class.output="scroll-200")
```



 Código original extraído desde  <https://github.com/jabbamodel/ss3diags>
<https://github.com/jabbamodel/ss3diags/blob/master/Cookbook/Run_Retrospective_example.R>




# Instalar librerías

```{r eval=FALSE}
devtools::install_github("jabbamodel/ss3diags")
install.packages('r4ss')
install.packages('here')

```


# Cargar librerías

```{r}
library(here)
library(r4ss)
library(ss3diags)

```


# 1. Identificar el directorio donde se encuentra el modelo base 
```{r}
dirname.model.run <- here("modelos_SS3","simple")
```



# 2. Crear un nuevo directorio para el `Hindcast`  
```{r}
dirname.Hindcast <- here("Ejercicios","7.Hindcast") 
dir.create(path=dirname.Hindcast, showWarnings = TRUE, recursive = TRUE)
```



# 3. Crear un subdirectorio llamado `plots_Hindcast`
```{r}
plotdir=paste0(dirname.Hindcast,"/plots_Hindcast")
dir.create(path=plotdir, showWarnings = TRUE, recursive = TRUE)
```



# 4. Crear un subdirectorio llamado `simple`
```{r}
reference.dir <- paste0(dirname.Hindcast,'/simple') 
dir.create(path=reference.dir, showWarnings = TRUE, recursive = TRUE)

```


# 5. Copiar el resultado del modelo base completo en este directorio 
```{r}
file.copy(Sys.glob(paste(dirname.model.run, "*.*", sep="/"),
                   dirmark = FALSE),
          reference.dir)
```


# Ejecutar SS3

```{r}
r4ss::run_SS_models(dirvec = reference.dir, 
                    model = "ss_win.exe" ,
                    skipfinished = FALSE)
```


# 6. Leer la salida del modelo base 
```{r}
Base <- SS_output(dir=reference.dir,covar=T)
```


# 7. Copiar los archivos necesarios de "simple" al directorio `Hindcast`
```{r}
copy_SS_inputs(dir.old = reference.dir, 
               dir.new =  dirname.Hindcast,
               copy_exe = TRUE,
               verbose = FALSE)
```


# 8. Leer los archivos del modelo 
```{r}
inputs <- r4ss::SS_read(dir = dirname.Hindcast)
```


# 9. Editar el archivo starter para que muestre una línea de visualización por cada iteración 
```{r}
inputs$start$run_display_detail <- 1
```



# 10. Escribir los modelos modificados 
```{r}
r4ss::SS_write(inputs, dir = dirname.Hindcast, overwrite = TRUE)
```


# 11. Identificar el período Hindcast 
```{r}
start.retro <- 0    # último año del modelo
end.retro   <- 5    # número de años para el Hindcast 
```



# 12. Ejecutar la función `SS_doRetro()` 
```{r eval=T}
#?SS_doRetro()
SS_doRetro(masterdir=dirname.Hindcast,
           oldsubdir="", 
           newsubdir="Hindcast",
           years=start.retro:-end.retro)
```

# 13. Leer los archivos de salida `SSgetoutput()` 
```{r}
retroModels<-SSgetoutput(dirvec=file.path(dirname.Hindcast, "Hindcast", paste("retro",start.retro:-end.retro,sep="")))
```


# 14. Resumir las salidas con la función `SSsummarize()`  
```{r}
retroSummary <- SSsummarize(retroModels)
```


# 15. Funciones para generar plots de Hindcast `SSplotHCxval()`

## Hindcast Índices
```{r}
#png(file.path(plotdir,"Hindcast_ind.png"),width=9,height=4.5,res=300,units='in')
sspar(mfrow = c(1, 2), plot.cex = 0.8)
hci = SSplotHCxval(retroSummary, add = T, verbose = F, ylimAdj = 1.3, legendcex = 0.7)
#dev.off()
```



## Hindcast Composiciones de tallas

```{r}
retroC.len = SSretroComps(retroModels)
```

```{r}
#png(file.path(plotdir,"Hindcast_len.png"),width=9,height=4.5,res=300,units='in')
sspar(mfrow = c(1, 2), plot.cex = 0.8)
hcl = SSplotHCxval(retroC.len, 
                   subplots = "len", 
                   add = T, 
                   verbose = F, 
                   ylimAdj = 1.3,
                   legendcex = 0.7, 
                   indexselect = c(1, 2))
#dev.off()
```




## Hindcast Composiciones de edad
```{r}
retroC.age = SSretroComps(retroModels)
```

 
```{r}
#png(file.path(plotdir,"Hindcast_age.png"),width=9,height=4.5,res=300,units='in')
sspar(mfrow = c(1, 2), plot.cex = 0.8)
hcl = SSplotHCxval(retroC.age, 
                   subplots = "age", 
                   add = T, 
                   verbose = F, 
                   ylimAdj = 1.3,
                   legendcex = 0.7, 
                   indexselect = c(1, 2))
#dev.off()
```


# 16. Función para Tabla de MASE `SSmase()` 
```{r}
MAE.base.adj = 0.1
mase1 = SSmase(retroC.len, 
               quant = "len", 
               MAE.base.adj = 0.1, 
               indexselect = c(1:2))
```



```{r}
MAE.base.adj = 0.15
SSmase(retroC.len, 
       quant = "len", 
       MAE.base.adj = 0.15, 
       indexselect = c(1:2))
```


```{r}
mase1$MAE.PR/mase1$MAE.base

mase1$MASE

mase1$MAE.PR/pmax(mase1$MAE.base, 0.1)

mase1$MASE.adj

```

```{r}
SSmase(retroC.age, 
       quants = "age")
```




Una puntuación MASE > 1 indica que los pronósticos promedio del modelo son peores que una caminata aleatoria. 

Por el contrario, una puntuación MASE de 0,5 indica que el  modelo tiene habilidad de predicción.

