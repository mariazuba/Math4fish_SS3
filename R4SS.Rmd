---
title: "Correr modelo y visualizar salidas de SS3"
---

En esta sección seguiremos los pasos propuestos por el SS3 Development Team para Desarrollar nuestro primer modelo Stock Synthesis (SS3) https://nmfs-stock-synthesis.github.io/doc/ss_model_tips.html.


# Cómo crear nuevos modelos SS3

# Sobre la especificación del modelo

# Fases en SS3 y ADMB

# Debugging básicos: use echoinput.sso y warning.sso

# Visualización de resultados

La visualización es útil a medida que desarrolla iterativamente su modelo y para la presentación de los resultados finales del modelo. La salida de un modelo SS3 se puede leer en r4ss. La viñeta r4ss tiene más información sobre cómo usar el paquete de R r4ss.

# Flujo de trabajo propuesto para llegar a un modelo FINAL

¡Es importante recordar que llegar a un modelo lleva tiempo y muchas iteraciones! Debe planear hacer pequeñas revisiones, volver a ejecutar el modelo y ver cómo ha cambiado el modelo con cada pequeña revisión. Por lo general, se requieren muchas ejecuciones intermedias del modelo antes de llegar a un modelo final. Como mínimo, mantenga notas dentro de la carpeta de la ejecución o en otro lugar con respecto a los cambios específicos de la ejecución. El uso del control de versiones también podría ser útil para realizar un seguimiento de los cambios en el modelo. A continuación, proporcionamos algunas sugerencias sobre los pasos a seguir a medida que itera hacia su modelo "final".

## Primer paso: ejecutar el modelo sin estimación

Primero, verifique que SS3 lea los archivos de entrada según lo previsto. Utilice las opciones de línea de comando -stopph 0 -nohess para ejecutar el modelo sin estimación. Luego, examine los archivos de **warning.sso**, **echoinput.sso** y **.ss_new files** producidos para ver cómo SS3 interpretó sus archivos de entrada y si fue como pretendía.

Una vez que haya verificado que SS3 está leyendo su entrada correctamente, también puede considerar ajustar los parámetros de selectividad, crecimiento y reclutamiento.

## Segundo paso: ejecutar estimando algunos parámetros

Intente cambiar la fase máxima para que sea mayor que 0 (quizás 2 o 3) para estimar algunos pero no todos los parámetros. Haga esto usando -stopph x -nohess, donde x debe ser la fase máxima deseada (por ejemplo, 2 o 3). -nohess todavía se usa para reducir el tiempo de ejecución. Durante esta etapa de las ejecuciones del modelo, debe intentar ajustar el modelo para resolver todos los patrones principales en los residuales. Esto puede incluir considerar y realizar cambios en la estructura del modelo.

## Tercer paso: ejecutar estimando todos los parámetros

Una vez que se hayan resuelto todos los patrones principales en los residuos, intente estimar todos los parámetros en el modelo. Cambie la fase máxima para incluir todas las fases de su modelo (es decir, igual o superior a la fase más alta especificada en su modelo). Querrá hacer varias ejecuciones para diferentes propósitos de refinamiento del modelo en este momento:

1. Realice una o más corridas con la hessiana estimada para obtener la varianza de las desviaciones de reclutamiento y luego use este vector de varianzas para ajustar la rampa de ajuste del sesgo (consulte el Manual del usuario de SS3 para obtener detalles adicionales).
2. Realice ejecuciones con o sin estimar la hessiana para ajustar las ponderaciones de datos.
3. Ejecute el modelo varias veces y altere los valores iniciales (la opción de fluctuación se selecciona en starter.ss). Esto ejecuta el modelo con nuevos valores de parámetros iniciales para determinar si es posible un mejor ajuste del modelo utilizando diferentes valores iniciales.


Después de estas ejecuciones, su modelo debería estar ajustado y listo para las ejecuciones finales.

# Debugging avanzado

En esta sección, hemos enumerado algunos problemas comunes que puede encontrar y algunas técnicas para resolverlos dentro de su modelo.

## Si los residuos tienen patrones sustanciales

A menudo es difícil identificar la causa de los residuos que tienen patrones sustanciales, pero dos posibles razones por las que esto podría suceder son valores iniciales poco realistas o una especificación de modelo deficiente. Si tiene residuos con un patrón sustancial, puede intentar cambiar los valores iniciales. Si un parámetro no se mueve del valor inicial, es posible que no haya suficiente información para determinar su valor y que sea necesario fijar el valor en el modelo. Si el parámetro se mueve con diferentes valores iniciales, es posible que el valor inicial utilizado antes no fuera razonable y, por lo tanto, cambiar el valor inicial a un valor razonable soluciona el problema.

## Si SS3 se ejecuta, pero hay un gradiente final muy grande

Los gradientes grandes generalmente se informan en el archivo de **warnings.sso**, por lo que este problema debería estar claro al examinar el archivo después de ejecutar un modelo. Si este es el caso, intente lo siguiente:

* Examine **Report.sso** en busca de parámetros que estén dentro o cerca de los límites, ya que estos pueden ser los parámetros que están causando problemas. Depende del valor, pero puede considerar cambiar sus límites o los parámetros, según lo que parezca más plausible dado su modelo.
* Examine los residuos para identificar si hay una  falta de ajuste general. Esto puede indicar que el algoritmo ADMB no pudo encontrar el mínimo global. Pruebe valores iniciales alternativos para intentar resolver este problema. Sin embargo, también es posible que haya un gran conflicto entre la estructura de su modelo y el archivo de su modelo, en cuyo caso es posible que desee reconsiderar la especificación del modelo; tal vez haya una estructura de modelo alternativa que tenga más sentido para la población.


## Si la Hessiana no se invierte

La información de de la Hessiana se informa en el archivo Report.sso, así que vaya a esta sección para confirmar si se trata de un problema. Este es un problema difícil de resolver, pero puede ser necesario considerar modelos alternativos si la arpillera no se invierte.

# Algunas preguntas a considerar durante el desarrollo del modelo

Hay muchos elementos a considerar en un modelo SS3. A continuación se presentan algunas preguntas y consideraciones que los usuarios experimentados de SS3 han utilizado para comprobar que su modelo tiene sentido durante todo el proceso de desarrollo iterativo del modelo.

## ¿Mi modelo tiene sentido?

* ¿Tiene sentido la biología? ¿Selectividad?
* ¿El modelo se ajusta a los índices? ¿Datos de longitud y edad?
* ¿Cuál es el patrón en el reclutamiento?
* ¿Las priors coinciden con lo que pensé que estaba especificando?

## ¿Mi modelo ajusta bien?

La función r4ss::SS_output() imprime algunos diagnósticos muy útiles en la ventana de la consola R, incluida una lista de los parámetros estimados, el valor estimado, si el parámetro está alcanzando un límite, el gradiente y el tipo anterior. Utilice este (u otros archivos de salida SS3) para responder:

* ¿Se movió el parámetro del valor inicial?
* ¿Está el parámetro llegando a un límite?
* ¿El gradiente del parámetro es bajo?

Debajo de las estimaciones de parámetros que r4ss::SS_output() imprime en la consola, hay una sección específica que resalta los parámetros con los gradientes de modelo más altos. Examinar esta lista podría indicar qué parámetros (si los hay) pueden necesitar ser corregidos debido a la falta de información en los datos.

Por ejemplo, puede haber parámetros de selectividad incluidos en la lista donde pequeños cambios en el valor del parámetro no cambian los resultados del modelo (o la forma de la selectividad).

## ¿Mi ponderación de datos tiene sentido?

La función r4ss::SS_output() imprime información sobre la sintonización de la consola R. Esto incluye información de ajuste para datos de longitud y edad que se pueden usar para la ponderación de datos cuando se usa la ponderación de McAllister Ianelli (es decir, ponderación por la media armónica).

La función r4ss::SS_plots() crea cifras medias de longitud y edad con leyendas que muestran los pesos de Francis recomendados para cada fuente de datos. Incluso si está utilizando un enfoque de ponderación de datos alternativo (es decir, Francis, Dirichlet u otro), siempre es una buena práctica explorar un enfoque alternativo y ver cómo la ponderación de datos cambia el modelo.

## ¿Ajusté correctamente la variación del reclutamiento?

Verifique la información de sigmaR (es decir, desviación estándar de desarrollo de reclutamiento). El parámetro sigmaR generalmente se fija dentro del modelo, por lo que si no se fija dentro de su modelo, debe considerar si tiene o no sentido para la población y dada la calidad y cantidad de datos.

Para un valor fijo de sigmaR, una sección del resultado proporcionará diagnósticos para determinar si el valor fijo de sigmaR está capturando las variaciones estimadas en el reclutamiento. La función r4ss::SS_output() imprimirá un valor recomendado basado en la variación en las desviaciones de reclutamiento estimadas que quizás desee considerar usar.



```{css,echo=FALSE}
.scroll-200{
            max-height: 200px; 
            overflow-y: auto; 
            background-color: #f1f1f1;
            }
```


```{css,echo=FALSE}

/*----------LOGO above TOC---------*/

#TOC::before {
  content: "";
  display: block;
  height: 100px;
  margin: 2em 20px 40px 20px;
  background-image: url("LOGO_2SN_recortado.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}

```


```{r echo=F, message=F,warning=F,}

library(reshape2)
require(dplyr)
require(tidyr)
library(knitr) #Rmarkdown
library(ggplot2) # plot
library(patchwork) # plot
library(kableExtra) # genera tablas
library(r4ss)
library(ss3diags)

# remotes::install_github("gadget-framework/rgadget")
# library(Rgadget) # tengo problemas para instalar esta libreria


#remotes::install_github("PIFSCstockassessments/ss3diags")

mod_path<-(paste(getwd(),'/quarter/10a_anchcadiz',sep=""))

knitr::opts_chunk$set(echo=T, warning=F, message=F)

```




## SALIDAS SS3 {.tabset .tabset-fade .tabset-pills}

```{r , message=F,warning=F,eval=F,incluide=F}

exe_path <- paste(mod_path,"ss.exe",sep= "/")
r4ss::run_SS_models(dirvec = mod_path, model = exe_path, 
                    skipfinished = FALSE)


```

```{r echo=F, message=F,warning=F,include=F, eval=T}

# initial model to modify
mod_path<-(paste(getwd(),'/quarter/10a_anchcadiz',sep=""))

# create a new directory to put a new, modified version of the model
new_mod_path <- (paste(getwd(),'/quarter/10a_anchcadiz_new',sep=""))


replist <- SS_output(dir = mod_path, 
                     verbose = TRUE,
                     printstats = TRUE)

```


### Biología

Estos gráficos corresponden a las salidas de curva de crecimiento,  peso medios, madurez y desove.


```{r message=F,warning=F,eval=T, fig.align='center',fig.width=8,fig.height=9}

sspar(mfrow = c(3, 2), plot.cex = 0.7)
SSplotBiology(replist, subplot = c(1,5,6,10,11))

```


```{r}

parbio1<-replist$estimated_non_dev_parameters

kbl(parbio1, booktabs = T,position="h!",
    caption = "Estimated non dev parameters") %>%
    kable_styling("striped",
    full_width = FALSE,font_size=12)%>% 
    scroll_box(width="100%")

```

La distribución de talla a la edad o la edad observada a al edad real se representa como un histograma. Los valores son de las secciones de Report.sso llamadas AGE_LENGTH-KEY y AGE_AGE_KEY.


```{r message=F,warning=F, fig.align='center',fig.width=9,fig.height=9.5}

sspar(mfrow = c(4, 2), plot.cex = 0.5)

SSplotAgeMatrix(replist)

```

### Selectividad

```{r message=F,warning=F,fig.align='center',fig.width=5.5,fig.height=4.5}

SSplotSelex(replist,subplot =1)

```

```{r message=F,warning=F,fig.align='center',fig.width=5.5,fig.height=4.5}

SSplotSelex(replist,subplot =2)

```

### Series de tiempo

```{r message=F,warning=F,fig.align='center',fig.width=8.5,fig.height=10}

sspar(mfrow = c(4, 2), plot.cex = 0.6)

SSplotTimeseries(replist,subplot =1)
SSplotTimeseries(replist,subplot =3)
SSplotTimeseries(replist,subplot =4)
SSplotTimeseries(replist,subplot =6)
SSplotTimeseries(replist,subplot =7)
SSplotTimeseries(replist,subplot =9)
SSplotTimeseries(replist,subplot =10)
SSplotTimeseries(replist,subplot =11)

```


### Capturas

```{r message=F,warning=F,eval=T,fig.align='center',fig.width=6.5,fig.height=4.5}

SSplotCatch(replist, subplots =c(2,9, 10))

```

### Índices

```{r message=F,warning=F,fig.align='center',fig.width=8.5,fig.height=5.5}
sspar(mfrow = c(2, 2), plot.cex = 0.6)
SSplotIndices(replist, subplots = c(9,2,7))

```

### Datos

```{r message=F,warning=F,eval=T, fig.align='center',fig.width=6.5,fig.height=4.5,fig.cap="Datos de entrada al modelo"}

SSplotData(replist, subplot = 1)

```

### Relación stock-recluta

```{r message=F,warning=F,fig.align='center',fig.width=8.5,fig.height=4.5}
sspar(mfrow = c(1, 2), plot.cex = 0.8)
SSplotSpawnrecruit(replist,subplot =2:3,legend = T)

```
