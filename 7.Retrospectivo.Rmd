---
title: "Análisis Retrospectivo"
---

```{css,echo=FALSE}
.scroll-200{
            max-height: 200px; 
            overflow-y: auto; 
            background-color: #f1f1f1;
            }
```


```{css,echo=FALSE}
/*----------LOGO above TOC---------*/
#TOC::before {
  content: "";
  display: block;
  height: 100px;
  margin: 2em 20px 40px 20px;
  background-image: url("LOGO_2SN_recortado.png");
  background-size: contain;
  background-position: center center;
  background-repeat: no-repeat;
}
```



```{r global-options, include=FALSE}
knitr::opts_chunk$set(eval=T,echo=T, warning=FALSE, message=FALSE,class.output="scroll-200")
```


Un análisis retrospectivo elimina una cierta cantidad de años de los datos del  modelo y vuelve a calcular el ajuste. Por lo general, esto se hace varias veces  y los resultados se utilizan para buscar patrones retrospectivos.



 Código original extraído desde  <https://github.com/jabbamodel/ss3diags>
<https://github.com/jabbamodel/ss3diags/blob/master/Cookbook/Run_Retrospective_example.R>




# Instalar librerías

```{r eval=FALSE}
devtools::install_github("jabbamodel/ss3diags")
install.packages('r4ss')
install.packages('here')

```


# Cargar librerías

```{r}
library(here)
library(r4ss)
library(ss3diags)

```


# 1. Identificar el directorio donde se encuentra el modelo base 

```{r}
dirname.model.run <- here("modelos_SS3","simple")
```

# 2. Crear un nuevo directorio para el `Retrospectivo`

```{r}
dirname.Retrospective <- here("Ejercicios","7.Retrospectivo") 
dir.create(path=dirname.Retrospective, showWarnings = TRUE, recursive = TRUE)
```



# 3. Crear un subdirectorio llamado `plots_Verosimilitud` 
```{r}
plotdir=paste0(dirname.Retrospective,"/plots_Retrospectivo")
dir.create(path=plotdir, showWarnings = TRUE, recursive = TRUE)
```



# 4. Crear un subdirectorio llamado `simple`
```{r}
reference.dir <- paste0(dirname.Retrospective,'/simple') 
dir.create(path=reference.dir, showWarnings = TRUE, recursive = TRUE)
```


# 5. Copiar el resultado del modelo base completo en este directorio

```{r}
file.copy(Sys.glob(paste(dirname.model.run, "*.*", sep="/"),
          dirmark = FALSE),
          reference.dir)
```


# Ejecutar SS3

```{r}
r4ss::run_SS_models(dirvec = reference.dir, 
                    model = "ss_win.exe" ,
                    skipfinished = FALSE)
```

                    
                    
# 6. Leer la salida del modelo base 
```{r}
Base <- SS_output(dir=reference.dir,covar=T)
```


# 7. Copiar los archivos necesarios de "simple" al directorio `Perfil_Verosimilitud`.

```{r}
copy_SS_inputs(dir.old = reference.dir, 
               dir.new =  dirname.Retrospective,
               copy_exe = TRUE,
               verbose = FALSE)
```

# 8. Leer los archivos del modelo 

```{r}
inputs <- r4ss::SS_read(dir = dirname.Retrospective)
```


# 9. Editar el archivo starter para que muestre una línea de visualización por cada iteración 

```{r}
inputs$start$run_display_detail <- 1
```


# 10. Escribir los modelos modificados 
```{r}
r4ss::SS_write(inputs, dir = dirname.Retrospective, overwrite = TRUE)
```


# 11. Identificar el período retrospectivo 
```{r}
start.retro <- 0    # último año del modelo
end.retro   <- 5    # número de años para el retrospectivo 
```


# 12. Ejecutar la función `SS_doRetro()` 
```{r eval=T}
#?SS_doRetro()
SS_doRetro(masterdir=dirname.Retrospective,
           oldsubdir="", 
           newsubdir="Retrospectives",
           years=start.retro:-end.retro)
```


# 13. Leer los archivos de salida `SSgetoutput()` 
```{r}
retroModels<-SSgetoutput(dirvec=file.path(dirname.Retrospective, "Retrospectives", paste("retro",start.retro:-end.retro,sep="")))
```


# 14. Resumir las salidas con la función `SSsummarize()`  
```{r}
retroSummary <- SSsummarize(retroModels)
```


# 15. Funciones para generar plots de Retrospectivo `SSplotRetro()`

## forecast =FALSE 
```{r}
#png(file.path(plotdir,"Retrospectivo.png"),width=7,height=4.5,res=300,units='in')
sspar(mfrow=c(1,2),plot.cex=0.8)
rb = SSplotRetro(retroSummary,
                 add=T,
                 forecast = F,
                 legend = F,
                 verbose=F)

rf = SSplotRetro(retroSummary,
                 add=T,
                 subplots="F", 
                 ylim=c(0,0.4),
                 forecast = F,
                 legendloc="topleft",
                 legendcex = 0.8,
                 verbose=F)
#dev.off()
```



## forecast=TRUE 
```{r}
#png(file.path(plotdir,"Retrospectivo2.png"),width=7,height=4.5,res=300,units='in')
sspar(mfrow = c(2, 1), plot.cex = 0.8)

SSplotRetro(retroSummary, 
            add = T, 
            forecast = T, 
            legend = F, 
            verbose = F, 
            xmin = 1970)

SSplotRetro(retroSummary, 
            add = T, 
            subplots = "F", 
            ylim = c(0, 0.5), 
            forecast = T,
            legendloc = "topleft", 
            legendcex = 0.8, 
            verbose = F, 
            xmin = 1970)

#dev.off()
```



#16. Función para Tabla de Rho `SShcbias()` 

```{r}
SShcbias(retroSummary,quant="SSB",verbose=F)

SShcbias(retroSummary,quant="F",verbose=F)

```






